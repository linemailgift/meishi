<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Chiikuji Meishi">
    <title>Chiikuji Meishi</title>
    <!-- ホーム画面用アイコン（JSで動的に更新されます） -->
    <link rel="apple-touch-icon" id="app-icon-apple" href="">
    <link rel="shortcut icon" id="app-icon-default" href="">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* カスタムアニメーションとスタイル */
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            transition: background-color 0.5s ease, background-image 0.5s ease;
            -webkit-tap-highlight-color: transparent;
            background-color: #f8f9fa; 
            min-height: 100vh;
        }

        /* 拡大時のアニメーション用クラス */
        .focused-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #ffffff;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            padding: 2rem 1rem 7rem 1rem; 
            animation: fadeIn 0.2s ease-out;
        }

        .meishi-card {
            background: rgba(255, 255, 255, 0.90);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 2rem;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            border: 1px solid rgba(255,255,255,0.4);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .slide-in-right { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-in-left { animation: slideInLeft 0.3s cubic-bezier(0.16, 1, 0.3, 1); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInLeft { from { transform: translateX(-100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .qr-code-container img,
        .qr-code-container canvas {
            width: 180px !important;
            height: 180px !important;
            margin: 0 auto;
            border-radius: 4px;
        }

        /* 汎用クラス */
        .hidden-card { display: none !important; }
        
        .img-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e5e7eb;
            background-color: #fff;
        }

        .list-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .focus-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .bottom-nav {
            position: absolute;
            bottom: 2rem;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 0 1rem;
            z-index: 60;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .bottom-nav::-webkit-scrollbar { display: none; }

        .nav-item-wrapper {
            position: relative;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .nav-item-wrapper:active { transform: scale(0.95); }
        .nav-item-wrapper.active { transform: translateY(-4px); }

        .nav-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.8);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            opacity: 0.6;
            background-color: #f3f4f6;
        }
        .nav-item-wrapper.active .nav-icon {
            border-color: #4f46e5;
            opacity: 1;
            box-shadow: 0 4px 8px rgba(79, 70, 229, 0.3);
        }

        .platform-badge {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border: 1px solid rgba(0,0,0,0.1);
            z-index: 10;
        }

        .tab-active {
            border-bottom: 3px solid #4f46e5;
            color: #4f46e5;
            font-weight: 700;
        }
        .tab-inactive {
            border-bottom: 3px solid transparent;
            color: #9ca3af;
            font-weight: 500;
        }

        .list-item {
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
        }
        .list-item:active { transform: scale(0.98); }

        .color-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .color-btn:hover { transform: scale(1.1); }
        .color-btn.selected { border-color: #4f46e5; transform: scale(1.1); box-shadow: 0 0 0 2px #c7d2fe; }

        /* ブランド別カラー定義 (CSSクラス用フォールバック) */
        .text-red-600 { color: #dc2626; }
        .text-pink-600 { color: #db2777; }
        .text-blue-600 { color: #2563eb; }
        .text-indigo-600 { color: #4f46e5; }
        .text-black { color: #000000; }
        .text-white { color: #ffffff; }
        .bg-black { background-color: #000000; }
        .bg-white { background-color: #ffffff; }

    </style>
</head>
<body id="app-body" class="pb-20">

    <!-- ヘッダー -->
    <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-30 pt-3 pb-0">
        <div class="max-w-md mx-auto px-4 flex justify-between items-center mb-3">
            <h1 class="text-xs text-gray-400 font-light tracking-widest uppercase">
                Chiikuji Meishi
            </h1>
            <button onclick="openSettings()" class="text-gray-400 hover:text-gray-600 p-2">
                <i class="fa-solid fa-gear text-lg"></i>
            </button>
        </div>

        <!-- アカウント切り替えタブ -->
        <div class="flex max-w-md mx-auto w-full px-4">
            <button onclick="switchTab('account1')" id="tab-btn-account1" class="flex-1 py-3 text-sm text-center transition tab-active truncate px-2">
                Account 1
            </button>
            <button onclick="switchTab('account2')" id="tab-btn-account2" class="flex-1 py-3 text-sm text-center transition tab-inactive truncate px-2">
                Account 2
            </button>
        </div>
    </header>

    <!-- 設定モーダル -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md h-[90vh] flex flex-col">
            <!-- モーダルヘッダー -->
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <h2 class="font-bold text-gray-700">設定</h2>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>

            <!-- モーダル内のタブ切り替え -->
            <div class="flex border-b bg-white">
                <button onclick="switchSettingsTab('account1')" id="set-tab-account1" class="flex-1 py-3 text-xs font-bold text-center border-b-2 border-indigo-600 text-indigo-600 bg-indigo-50 truncate px-1">
                    Account 1
                </button>
                <button onclick="switchSettingsTab('account2')" id="set-tab-account2" class="flex-1 py-3 text-xs font-bold text-center border-b-2 border-transparent text-gray-500 hover:bg-gray-50 truncate px-1">
                    Account 2
                </button>
            </div>
            
            <!-- 設定フォームコンテナ -->
            <div class="flex-1 overflow-y-auto p-4 bg-gray-50">
                
                <!-- 基本設定セクション -->
                <div class="bg-white p-5 rounded-xl shadow-sm mb-6 border border-indigo-100">
                    <h3 class="text-xs font-bold text-indigo-500 uppercase tracking-wider mb-4 border-b pb-2">基本設定</h3>
                    
                    <!-- タブ名変更 -->
                    <div class="mb-5">
                        <label class="block text-xs font-bold text-gray-600 mb-1">タブの名称</label>
                        <input type="text" id="setting-tab-name" placeholder="例: 本垢, 趣味垢" 
                            class="w-full text-sm p-2 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:border-indigo-400 transition">
                    </div>

                    <!-- アプリのテーマカラー設定 -->
                    <div class="mb-5">
                        <label class="block text-xs font-bold text-gray-600 mb-2">アプリ全体のテーマカラー</label>
                        <div class="flex flex-wrap gap-3 mb-2">
                            <button onclick="setThemeColor('#f8f9fa')" class="color-btn selected" style="background-color: #f8f9fa;" title="デフォルト"></button>
                            <button onclick="setThemeColor('#e0f2fe')" class="color-btn" style="background-color: #e0f2fe;" title="パステルブルー"></button>
                            <button onclick="setThemeColor('#fce7f3')" class="color-btn" style="background-color: #fce7f3;" title="パステルピンク"></button>
                            <button onclick="setThemeColor('#ecfccb')" class="color-btn" style="background-color: #ecfccb;" title="パステルライム"></button>
                            <button onclick="setThemeColor('#1f2937')" class="color-btn" style="background-color: #1f2937;" title="ダーク"></button>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="color" id="custom-theme-color" onchange="setThemeColor(this.value)" class="h-8 w-12 p-0 border rounded cursor-pointer">
                            <span class="text-xs text-gray-500">カスタム色</span>
                        </div>
                        <input type="hidden" id="setting-theme-color" value="#f8f9fa">
                    </div>

                    <!-- 名刺壁紙設定 -->
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-2">名刺拡大時の背景画像</label>
                        <div class="flex items-center space-x-3">
                            <div id="bg-preview-container" class="w-16 h-16 rounded-lg bg-gray-200 bg-cover bg-center border border-gray-300 relative overflow-hidden">
                                <div id="bg-no-image" class="absolute inset-0 flex items-center justify-center text-gray-400 text-xs">なし</div>
                            </div>
                            <div class="flex flex-col space-y-2">
                                <label class="cursor-pointer bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 text-xs py-2 px-3 rounded-lg transition shadow-sm text-center">
                                    <i class="fa-solid fa-image mr-1"></i> 画像を選択
                                    <input type="file" accept="image/*" class="hidden" onchange="handleBgUpload(this)">
                                </label>
                                <button type="button" onclick="clearBg()" id="btn-clear-bg" class="text-xs text-red-400 hover:text-red-600 hidden text-left px-1">
                                    <i class="fa-solid fa-trash mr-1"></i>削除
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="setting-bg-data">
                    </div>
                </div>

                <!-- アカウントリンク設定 -->
                <div class="flex items-center justify-between mb-4 mt-6 px-1">
                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">リンク設定・QR色変更</p>
                </div>

                <!-- フォーム生成エリア -->
                <div id="settings-forms-container">
                    <!-- JSで動的に生成されます -->
                </div>
                
                <!-- ホーム画面追加ボタン -->
                <div class="mt-8 mb-4 text-center">
                    <button onclick="showAddToHomeGuide()" class="text-xs text-gray-500 hover:text-indigo-600 underline">
                        <i class="fa-solid fa-mobile-screen-button mr-1"></i>ホーム画面にアイコンを追加するには
                    </button>
                </div>

                <!-- データバックアップ・復元 -->
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4 text-center">データ管理（バックアップ）</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="exportData()" class="bg-gray-100 text-gray-600 text-xs font-bold py-3 rounded-lg hover:bg-gray-200 flex flex-col items-center justify-center space-y-1">
                            <i class="fa-solid fa-file-export text-lg"></i>
                            <span>ファイルに書き出し</span>
                        </button>
                        <label class="cursor-pointer bg-gray-100 text-gray-600 text-xs font-bold py-3 rounded-lg hover:bg-gray-200 flex flex-col items-center justify-center space-y-1">
                            <i class="fa-solid fa-file-import text-lg"></i>
                            <span>ファイルから読み込み</span>
                            <input type="file" accept=".json" class="hidden" onchange="importData(this)">
                        </label>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2 text-center">※ 機種変更時などは、書き出したファイルを新しい端末で読み込んでください。</p>
                </div>

                <!-- アプリシェアQRコード -->
                <div class="mt-8 pt-6 border-t border-gray-200 text-center">
                    <h3 class="text-xs font-bold text-indigo-500 uppercase tracking-wider mb-4">このアプリをシェアする</h3>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 inline-block">
                        <div id="share-app-qr" class="qr-code-container"></div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-3 px-4">
                        このQRコードを読み取ると、<br>現在開いているアプリのページを開けます。<br>
                        （友人にアプリを教える時に使ってください）
                    </p>
                    <div class="mt-2 text-[10px] text-gray-300 break-all px-4" id="current-url-display"></div>
                </div>

                <div class="h-8"></div>
            </div>

            <!-- 保存ボタン -->
            <div class="p-4 border-t bg-white rounded-b-2xl shadow-inner z-10">
                <button onclick="saveAndRegenerate()" class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-indigo-700 transform active:scale-95 transition flex justify-center items-center">
                    <i class="fa-solid fa-check mr-2"></i> 保存して更新
                </button>
            </div>
        </div>
    </div>

    <!-- ホーム画面追加ガイドモーダル -->
    <div id="pwa-guide-modal" class="hidden fixed inset-0 bg-black/70 z-[60] flex items-center justify-center p-6" onclick="closeAddToHomeGuide()">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl relative" onclick="event.stopPropagation()">
            <button onclick="closeAddToHomeGuide()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
            
            <div class="text-center mb-6">
                <i class="fa-solid fa-share-nodes text-4xl text-indigo-500 mb-3"></i>
                <h3 class="text-lg font-bold text-gray-800">ホーム画面に追加</h3>
            </div>
            
            <div class="space-y-6 text-sm text-gray-600">
                <div>
                    <h4 class="font-bold text-gray-800 mb-2 flex items-center"><i class="fa-brands fa-apple text-lg mr-2"></i> iPhone</h4>
                    <ol class="list-decimal list-inside space-y-1 pl-1"><li>共有ボタン <i class="fa-solid fa-arrow-up-from-bracket mx-1"></i> をタップ</li><li>「ホーム画面に追加」を選択</li></ol>
                </div>
                <div>
                    <h4 class="font-bold text-gray-800 mb-2 flex items-center"><i class="fa-brands fa-android text-lg mr-2 text-green-600"></i> Android</h4>
                    <ol class="list-decimal list-inside space-y-1 pl-1"><li>メニュー <i class="fa-solid fa-ellipsis-vertical mx-1"></i> をタップ</li><li>「ホーム画面に追加」を選択</li></ol>
                </div>
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="closeAddToHomeGuide()" class="bg-gray-100 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-200">閉じる</button>
            </div>
        </div>
    </div>

    <!-- メインコンテンツエリア -->
    <main class="max-w-md mx-auto p-4 pt-6">
        
        <!-- プロンプト: データがない場合の表示 -->
        <div id="empty-state" class="hidden text-center py-10">
            <div class="bg-white/80 backdrop-blur rounded-xl p-8 shadow-sm border border-white/50">
                <i class="fa-solid fa-qrcode text-5xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 text-sm mb-6">リンクが設定されていません</p>
                <button onclick="openSettings()" class="bg-white text-gray-600 border border-gray-200 px-4 py-2 rounded-lg text-sm font-medium shadow-sm">
                    設定画面へ
                </button>
            </div>
        </div>

        <!-- リスト表示エリア -->
        <div id="qr-list" class="space-y-3 pb-8"></div>
    </main>

    <!-- フォーカスビューのオーバーレイ（名刺ビュー） -->
    <div id="focus-overlay" class="hidden">
        <!-- JSで注入 -->
    </div>

    <script>
        // 設定キーを新規リリース版に変更
        const STORAGE_KEY = 'chiikuji_meishi_release_v1';
        
        // 項目定義
        const platformKeys = [
            'youtube1', 
            'youtube2', 
            'instagram', 
            'x', 
            'tiktok', 
            'facebook', 
            'homepage', 
            'blog'
        ];

        // 設定定義（アイコンクラスを完全な形で定義して表示崩れを防止）
        const platformConfig = {
            'youtube1': { label: 'YouTube (Main)', icon: 'fa-brands fa-youtube', color: 'text-red-600', badgeClass: 'text-red-600', badgeBg: 'bg-white', defaultQrColor: '#CD201F' },
            'youtube2': { label: 'YouTube (Sub)', icon: 'fa-brands fa-youtube', color: 'text-red-600', badgeClass: 'text-red-600', badgeBg: 'bg-white', defaultQrColor: '#CD201F' },
            'instagram': { label: 'Instagram', icon: 'fa-brands fa-instagram', color: 'text-pink-600', badgeClass: 'text-pink-600', badgeBg: 'bg-white', defaultQrColor: '#C13584' },
            'tiktok': { label: 'TikTok', icon: 'fa-brands fa-tiktok', color: 'text-black', badgeClass: 'text-black', badgeBg: 'bg-white', defaultQrColor: '#000000' },
            'x': { label: 'X (Twitter)', icon: 'fa-brands fa-x-twitter', color: 'text-black', badgeClass: 'text-white', badgeBg: 'bg-black', defaultQrColor: '#333333' },
            'facebook': { label: 'Facebook', icon: 'fa-brands fa-facebook', color: 'text-blue-600', badgeClass: 'text-blue-600', badgeBg: 'bg-white', defaultQrColor: '#1877F2' },
            'homepage': { label: 'Homepage', icon: 'fa-solid fa-house', color: 'text-indigo-600', badgeClass: 'text-indigo-600', badgeBg: 'bg-white', defaultQrColor: '#4F46E5' },
            'blog': { label: 'Blog', icon: 'fa-solid fa-pen-nib', color: 'text-gray-600', badgeClass: 'text-gray-600', badgeBg: 'bg-white', defaultQrColor: '#4B5563' }
        };

        let currentTab = 'account1'; 
        let currentSettingsTab = 'account1';
        let appData = {
            account1: { config: { tabName: 'Account 1', bgImage: '', themeColor: '#f8f9fa' } },
            account2: { config: { tabName: 'Account 2', bgImage: '', themeColor: '#f8f9fa' } }
        };

        // スワイプ操作用の変数
        let touchStartX = 0;
        let touchEndX = 0;
        let currentFocusKey = null;

        const modal = document.getElementById('settings-modal');
        const listContainer = document.getElementById('qr-list');
        const emptyState = document.getElementById('empty-state');
        const focusOverlay = document.getElementById('focus-overlay');
        const settingsContainer = document.getElementById('settings-forms-container');
        const body = document.getElementById('app-body');
        const guideModal = document.getElementById('pwa-guide-modal');

        window.addEventListener('load', () => {
            loadData();
        });

        // ---------------------------------------------------------
        // UI初期化・構築
        // ---------------------------------------------------------

        function initializeList() {
            listContainer.innerHTML = '';
            platformKeys.forEach(key => {
                const config = platformConfig[key];
                // config.iconをそのままクラスとして使用
                const itemHtml = `
                    <div id="card-${key}" class="list-item rounded-2xl shadow-sm p-4 flex items-center space-x-4 cursor-pointer border border-white/50 hidden-card" onclick="focusCard('${key}')">
                        <div class="relative flex-shrink-0">
                            <img id="icon-${key}" src="" class="list-icon hidden bg-gray-50">
                            <div id="no-icon-${key}" class="list-icon hidden bg-gray-50 flex items-center justify-center text-gray-300 text-2xl"><i class="fa-solid fa-user"></i></div>
                            <div class="absolute -bottom-1 -right-1 bg-white rounded-full p-1 shadow-sm border border-gray-100 z-10">
                                <i class="${config.icon} ${config.color} text-sm w-4 h-4 flex items-center justify-center"></i>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">${config.label}</div>
                            <div id="display-name-${key}" class="font-bold text-gray-800 text-lg truncate"></div>
                        </div>
                        <div class="text-gray-400/50"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', itemHtml);
            });
        }

        function renderSettingsForm(tabName) {
            settingsContainer.innerHTML = '';
            const tabConfig = appData[tabName].config || {};
            document.getElementById('setting-tab-name').value = tabConfig.tabName || (tabName === 'account1' ? 'Account 1' : 'Account 2');
            
            const bgData = tabConfig.bgImage || '';
            document.getElementById('setting-bg-data').value = bgData;
            const bgPreview = document.getElementById('bg-preview-container');
            if(bgData) {
                bgPreview.style.backgroundImage = `url('${bgData}')`;
                document.getElementById('bg-no-image').classList.add('hidden');
                document.getElementById('btn-clear-bg').classList.remove('hidden');
            } else {
                bgPreview.style.backgroundImage = '';
                document.getElementById('bg-no-image').classList.remove('hidden');
                document.getElementById('btn-clear-bg').classList.add('hidden');
            }

            const themeColor = tabConfig.themeColor || '#f8f9fa';
            updateColorButtons(themeColor);

            platformKeys.forEach((key, index) => {
                const config = platformConfig[key];
                const currentVal = appData[tabName][key] || { url: '', name: '', image: '', qrColor: config.defaultQrColor, qrBgColor: '#FFFFFF' };
                
                let copyBtnHtml = '';
                if (index > 0) {
                    copyBtnHtml = `
                        <button type="button" onclick="copyProfileFromMain('${tabName}', '${key}')" class="text-xs text-indigo-600 font-bold hover:bg-indigo-50 px-2 py-1 rounded transition ml-auto border border-indigo-100">
                            <i class="fa-regular fa-copy mr-1"></i>アイコンと名前をコピー
                        </button>
                    `;
                }

                const html = `
                    <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-gray-100 relative">
                        <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-50">
                            <label class="block text-sm font-bold text-gray-700 flex items-center">
                                <i class="${config.icon} ${config.color} mr-2 text-lg w-6 text-center"></i>
                                ${config.label}
                            </label>
                            ${copyBtnHtml}
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <img id="preview-${tabName}-${key}" src="${currentVal.image || ''}" class="img-preview shadow-sm ${currentVal.image ? '' : 'hidden'}">
                                    <div id="no-preview-${tabName}-${key}" class="img-preview bg-gray-50 flex items-center justify-center text-gray-300 ${currentVal.image ? 'hidden' : ''}"><i class="fa-solid fa-user"></i></div>
                                </div>
                                <div class="flex flex-col space-y-2">
                                    <label class="cursor-pointer bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 text-xs py-2 px-3 rounded-lg transition shadow-sm text-center font-medium">
                                        <i class="fa-solid fa-camera mr-1"></i> アイコンを選択
                                        <input type="file" accept="image/*" class="hidden" onchange="handleImageUpload(this, '${tabName}', '${key}')">
                                    </label>
                                    <button type="button" onclick="clearImage('${tabName}', '${key}')" class="text-xs text-red-400 hover:text-red-600 ${currentVal.image ? '' : 'hidden'} text-left px-1" id="clear-${tabName}-${key}"><i class="fa-solid fa-trash mr-1"></i>削除</button>
                                </div>
                                <input type="hidden" id="img-data-${tabName}-${key}" value="${currentVal.image || ''}">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 mb-1">表示名</label>
                                <input type="text" id="name-${tabName}-${key}" value="${currentVal.name || ''}" placeholder="例: @my_account" class="w-full text-sm p-3 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:border-indigo-400 transition font-medium text-gray-800">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 mb-1">リンクURL</label>
                                <input type="url" id="input-${tabName}-${key}" value="${currentVal.url || ''}" placeholder="https://..." class="w-full text-sm p-3 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:border-indigo-400 transition text-gray-600">
                            </div>
                            <div class="flex items-center space-x-4 pt-2 border-t border-gray-50">
                                <div class="flex flex-col">
                                    <label class="text-[10px] font-bold text-gray-400 mb-1">QRコード色</label>
                                    <div class="flex items-center bg-gray-50 p-1 rounded-lg border border-gray-200">
                                        <input type="color" id="qr-color-${tabName}-${key}" value="${currentVal.qrColor || config.defaultQrColor || '#000000'}" class="w-8 h-8 rounded cursor-pointer border-none bg-transparent p-0">
                                    </div>
                                </div>
                                <div class="flex flex-col">
                                    <label class="text-[10px] font-bold text-gray-400 mb-1">背景色</label>
                                    <div class="flex items-center bg-gray-50 p-1 rounded-lg border border-gray-200">
                                        <input type="color" id="qr-bg-${tabName}-${key}" value="${currentVal.qrBgColor || '#FFFFFF'}" class="w-8 h-8 rounded cursor-pointer border-none bg-transparent p-0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                settingsContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        // ---------------------------------------------------------
        // ホーム画面アイコン自動設定
        // ---------------------------------------------------------
        function updateAppIcons() {
            // アイコン候補を探す順序 (Account1 -> Account2)
            const searchOrder = platformKeys; // youtube1, youtube2, ...
            let targetImage = null;

            // Account 1 から検索
            if (appData.account1) {
                for (const key of searchOrder) {
                    if (appData.account1[key]?.image) {
                        targetImage = appData.account1[key].image;
                        break;
                    }
                }
            }
            
            // 見つからなければ Account 2 から検索
            if (!targetImage && appData.account2) {
                for (const key of searchOrder) {
                    if (appData.account2[key]?.image) {
                        targetImage = appData.account2[key].image;
                        break;
                    }
                }
            }

            // アイコンタグにセット
            if (targetImage) {
                const appleIcon = document.getElementById('app-icon-apple');
                const defaultIcon = document.getElementById('app-icon-default');
                if (appleIcon) appleIcon.href = targetImage;
                if (defaultIcon) defaultIcon.href = targetImage;
            }
        }

        function renderShareQR() {
            const container = document.getElementById('share-app-qr');
            const urlDisplay = document.getElementById('current-url-display');
            if(!container) return;
            
            const currentURL = window.location.href.split('#')[0];
            container.innerHTML = '';
            urlDisplay.textContent = currentURL;

            new QRCode(container, {
                text: currentURL,
                width: 128,
                height: 128,
                colorDark : "#4f46e5",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.M
            });
        }

        function setThemeColor(color) {
            document.getElementById('setting-theme-color').value = color;
            updateColorButtons(color);
        }

        function updateColorButtons(activeColor) {
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('custom-theme-color').value = activeColor;
            
            const btns = document.querySelectorAll('.color-btn');
            for(let btn of btns) {
                if (rgbToHex(btn.style.backgroundColor) === activeColor.toLowerCase() || btn.style.backgroundColor === activeColor) {
                    btn.classList.add('selected');
                }
            }
        }
        
        function rgbToHex(rgb) {
            if (!rgb) return '';
            if (rgb.startsWith('#')) return rgb.toLowerCase();
            const rgbValues = rgb.match(/\d+/g);
            if (!rgbValues) return rgb;
            return "#" + ((1 << 24) + (parseInt(rgbValues[0]) << 16) + (parseInt(rgbValues[1]) << 8) + parseInt(rgbValues[2])).toString(16).slice(1).toLowerCase();
        }

        function applyTheme(color) {
            body.style.backgroundColor = color;
            const isDark = isDarkColor(color);
            if (isDark) {
                body.classList.add('text-white');
                body.classList.remove('text-gray-800');
            } else {
                body.classList.remove('text-white');
                body.classList.add('text-gray-800');
            }
        }

        function isDarkColor(color) {
            const hex = rgbToHex(color);
            if (!hex) return false;
            const r = parseInt(hex.substr(1, 2), 16);
            const g = parseInt(hex.substr(3, 2), 16);
            const b = parseInt(hex.substr(5, 2), 16);
            return ((r * 299 + g * 587 + b * 114) / 1000) < 128;
        }

        function exportData() {
            if(!modal.classList.contains('hidden')) {
                saveTempFormData(currentSettingsTab);
            }
            const dataStr = JSON.stringify(appData);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().slice(0,10).replace(/-/g, '');
            a.download = `chiikuji_meishi_backup_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.account1 && importedData.account2) {
                        if (confirm('現在のデータを上書きして読み込みますか？（この操作は取り消せません）')) {
                            appData = importedData;
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
                            alert('データを読み込みました。画面を更新します。');
                            location.reload();
                        }
                    } else {
                        alert('無効なファイル形式です。正しいバックアップファイルを選択してください。');
                    }
                } catch (err) {
                    alert('ファイルの読み込みに失敗しました。');
                    console.error(err);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function switchTab(tabName) {
            currentTab = tabName;
            updateTabUI();
            renderList();
            const theme = appData[currentTab].config?.themeColor || '#f8f9fa';
            applyTheme(theme);
        }

        function updateTabUI() {
            const name1 = appData.account1.config?.tabName || 'Account 1';
            const name2 = appData.account2.config?.tabName || 'Account 2';
            const btn1 = document.getElementById('tab-btn-account1');
            const btn2 = document.getElementById('tab-btn-account2');
            btn1.textContent = name1;
            btn2.textContent = name2;
            const activeClass = 'flex-1 py-3 text-sm text-center transition tab-active truncate px-2';
            const inactiveClass = 'flex-1 py-3 text-sm text-center transition tab-inactive truncate px-2';
            if (currentTab === 'account1') {
                btn1.className = activeClass;
                btn2.className = inactiveClass;
            } else {
                btn1.className = inactiveClass;
                btn2.className = activeClass;
            }
        }

        function switchSettingsTab(tabName) {
            saveTempFormData(currentSettingsTab);
            currentSettingsTab = tabName;
            const name1 = appData.account1.config?.tabName || 'Account 1';
            const name2 = appData.account2.config?.tabName || 'Account 2';
            document.getElementById('set-tab-account1').textContent = name1;
            document.getElementById('set-tab-account2').textContent = name2;
            const activeClass = "flex-1 py-3 text-xs font-bold text-center border-b-2 border-indigo-600 text-indigo-600 bg-indigo-50 truncate px-1";
            const inactiveClass = "flex-1 py-3 text-xs font-bold text-center border-b-2 border-transparent text-gray-500 hover:bg-gray-50 truncate px-1";
            document.getElementById('set-tab-account1').className = tabName === 'account1' ? activeClass : inactiveClass;
            document.getElementById('set-tab-account2').className = tabName === 'account2' ? activeClass : inactiveClass;
            renderSettingsForm(tabName);
        }

        function copyProfileFromMain(tabName, targetKey) {
            const mainKey = platformKeys[0]; 
            const nameInput = document.getElementById(`name-${tabName}-${mainKey}`);
            const imgInput = document.getElementById(`img-data-${tabName}-${mainKey}`);
            if (!nameInput || !imgInput) return;
            document.getElementById(`name-${tabName}-${targetKey}`).value = nameInput.value;
            document.getElementById(`img-data-${tabName}-${targetKey}`).value = imgInput.value;
            const preview = document.getElementById(`preview-${tabName}-${targetKey}`);
            const noPreview = document.getElementById(`no-preview-${tabName}-${targetKey}`);
            const clearBtn = document.getElementById(`clear-${tabName}-${targetKey}`);
            if (imgInput.value) {
                preview.src = imgInput.value;
                preview.classList.remove('hidden');
                noPreview.classList.add('hidden');
                clearBtn.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
                noPreview.classList.remove('hidden');
                clearBtn.classList.add('hidden');
            }
        }

        function openSettings() {
            currentSettingsTab = currentTab;
            switchSettingsTab(currentTab);
            renderShareQR();
            modal.classList.remove('hidden');
        }

        function closeSettings() {
            modal.classList.add('hidden');
        }

        function showAddToHomeGuide() { guideModal.classList.remove('hidden'); }
        function closeAddToHomeGuide() { guideModal.classList.add('hidden'); }

        function saveTempFormData(tabName) {
            const tabNameInput = document.getElementById('setting-tab-name');
            const bgInput = document.getElementById('setting-bg-data');
            const themeInput = document.getElementById('setting-theme-color');
            if (!appData[tabName]) appData[tabName] = {};
            if (!appData[tabName].config) appData[tabName].config = {};
            if(tabNameInput) appData[tabName].config.tabName = tabNameInput.value.trim();
            if(bgInput) appData[tabName].config.bgImage = bgInput.value;
            if(themeInput) appData[tabName].config.themeColor = themeInput.value;
            platformKeys.forEach(key => {
                const urlInput = document.getElementById(`input-${tabName}-${key}`);
                if (!urlInput) return;
                const qrColorInput = document.getElementById(`qr-color-${tabName}-${key}`);
                const qrBgInput = document.getElementById(`qr-bg-${tabName}-${key}`);
                appData[tabName][key] = {
                    url: urlInput.value.trim(),
                    name: document.getElementById(`name-${tabName}-${key}`).value.trim(),
                    image: document.getElementById(`img-data-${tabName}-${key}`).value,
                    qrColor: qrColorInput ? qrColorInput.value : '#000000',
                    qrBgColor: qrBgInput ? qrBgInput.value : '#FFFFFF'
                };
            });
        }

        function saveAndRegenerate() {
            saveTempFormData(currentSettingsTab);
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
                updateAppIcons(); // 保存時にアイコン更新
                closeSettings();
                switchTab(currentSettingsTab);
            } catch (e) {
                alert('データ量が大きすぎます。画像を減らすか、小さい画像を使用してください。');
                console.error(e);
            }
        }

        function loadData() {
            initializeList(); 
            const stored = localStorage.getItem(STORAGE_KEY);
            // 旧バージョンのデータ移行ロジックは削除しました (Version 1)
            if (stored) {
                try {
                    appData = JSON.parse(stored);
                    if (!appData.account1) appData.account1 = { config: { tabName: 'Account 1' } };
                    if (!appData.account2) appData.account2 = { config: { tabName: 'Account 2' } };
                } catch(e) { console.error(e); }
            }
            const theme = appData[currentTab].config?.themeColor || '#f8f9fa';
            applyTheme(theme);
            updateTabUI();
            renderList();
            updateAppIcons(); // 起動時にアイコン更新
        }

        function handleImageUpload(input, tabName, key) {
            processImage(input, 150, 0.7, (dataUrl) => {
                document.getElementById(`img-data-${tabName}-${key}`).value = dataUrl;
                const preview = document.getElementById(`preview-${tabName}-${key}`);
                const noPreview = document.getElementById(`no-preview-${tabName}-${key}`);
                preview.src = dataUrl;
                preview.classList.remove('hidden');
                noPreview.classList.add('hidden');
                document.getElementById(`clear-${tabName}-${key}`).classList.remove('hidden');
            });
        }

        function handleBgUpload(input) {
            processImage(input, 600, 0.6, (dataUrl) => {
                document.getElementById('setting-bg-data').value = dataUrl;
                const preview = document.getElementById('bg-preview-container');
                preview.style.backgroundImage = `url('${dataUrl}')`;
                document.getElementById('bg-no-image').classList.add('hidden');
                document.getElementById('btn-clear-bg').classList.remove('hidden');
            });
        }

        function processImage(input, maxSize, quality, callback) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                    } else {
                        if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    callback(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function clearImage(tabName, key) {
            document.getElementById(`img-data-${tabName}-${key}`).value = '';
            document.getElementById(`preview-${tabName}-${key}`).classList.add('hidden');
            document.getElementById(`no-preview-${tabName}-${key}`).classList.remove('hidden');
            document.getElementById(`clear-${tabName}-${key}`).classList.add('hidden');
        }

        function clearBg() {
            document.getElementById('setting-bg-data').value = '';
            document.getElementById('bg-preview-container').style.backgroundImage = '';
            document.getElementById('bg-no-image').classList.remove('hidden');
            document.getElementById('btn-clear-bg').classList.add('hidden');
        }

        function renderList() {
            const data = appData[currentTab] || {};
            let activeCount = 0;
            platformKeys.forEach(key => {
                const item = data[key] || {};
                const url = item.url;
                const card = document.getElementById(`card-${key}`);
                const nameContainer = document.getElementById(`display-name-${key}`);
                const iconImg = document.getElementById(`icon-${key}`);
                const noIconDiv = document.getElementById(`no-icon-${key}`);
                if (url) {
                    card.classList.remove('hidden-card');
                    card.style.display = 'flex'; 
                    activeCount++;
                    nameContainer.textContent = item.name || platformConfig[key].label;
                    if (item.image) {
                        iconImg.src = item.image;
                        iconImg.classList.remove('hidden');
                        noIconDiv.classList.add('hidden');
                    } else {
                        iconImg.classList.add('hidden');
                        noIconDiv.classList.remove('hidden');
                    }
                } else {
                    card.classList.add('hidden-card');
                    card.style.display = 'none';
                }
            });
            if (activeCount === 0) {
                listContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
            } else {
                listContainer.classList.remove('hidden');
                emptyState.classList.add('hidden');
            }
        }

        function focusCard(key) {
            currentFocusKey = key;
            renderFocusView();
            focusOverlay.classList.remove('hidden');
        }

        function renderFocusView(direction = '') {
            const data = appData[currentTab] || {};
            const item = data[currentFocusKey];
            if (!item || !item.url) return;
            const config = platformConfig[currentFocusKey];
            const displayName = item.name || config.label;
            const tabConfig = data.config || {};
            const bgImage = tabConfig.bgImage ? `background-image: url('${tabConfig.bgImage}');` : '';
            let animClass = '';
            if (direction === 'next') animClass = 'slide-in-right';
            if (direction === 'prev') animClass = 'slide-in-left';
            let imageHtml = item.image ? `<img src="${item.image}" class="focus-icon mb-4">` : `<div class="focus-icon mb-4 bg-gray-50 flex items-center justify-center text-4xl text-gray-300"><i class="fa-solid fa-user"></i></div>`;
            const activeKeys = platformKeys.filter(k => data[k] && data[k].url);
            let navHtml = '';
            activeKeys.forEach(k => {
                const navItem = data[k];
                const isActive = k === currentFocusKey ? 'active' : '';
                const navConfig = platformConfig[k]; 
                let navIconImg = navItem.image ? `<img src="${navItem.image}" class="nav-icon">` : `<div class="nav-icon flex items-center justify-center text-gray-400 text-lg"><i class="fa-solid fa-user"></i></div>`;
                const badgeHtml = `<div class="platform-badge ${navConfig.badgeBg} ${navConfig.badgeClass}"><i class="${navConfig.icon}"></i></div>`;
                navHtml += `<div class="nav-item-wrapper ${isActive}" onclick="event.stopPropagation(); switchTo('${k}')">${navIconImg}${badgeHtml}</div>`;
            });
            focusOverlay.innerHTML = `<div id="focus-content-wrapper" class="focused-view" style="${bgImage}" ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event)" onclick="closeFocus()"><div class="meishi-card ${animClass}" onclick="event.stopPropagation()">${imageHtml}<h2 class="text-2xl font-bold text-gray-800 mb-2 leading-tight line-clamp-2">${displayName}</h2><div class="flex items-center justify-center text-gray-500 mb-6 text-xs font-bold uppercase tracking-widest"><i class="${config.icon} ${config.color} mr-2"></i> ${config.label}</div><div id="focus-qr-target" class="qr-code-container bg-white p-2 rounded-xl shadow-inner border border-gray-100 mb-6"></div><button onclick="closeFocus()" class="mt-2 text-gray-400 text-sm hover:text-gray-600"><i class="fa-solid fa-xmark mr-1"></i> 閉じる</button></div><div class="bottom-nav" onclick="event.stopPropagation()">${navHtml}</div></div>`;
            const target = document.getElementById('focus-qr-target');
            new QRCode(target, {
                text: item.url,
                width: 256,
                height: 256,
                colorDark : item.qrColor || config.defaultQrColor || "#000000",
                colorLight : item.qrBgColor || "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        function switchTo(key) {
            if (key === currentFocusKey) return;
            const activeKeys = platformKeys.filter(k => appData[currentTab][k]?.url);
            const curIdx = activeKeys.indexOf(currentFocusKey);
            const newIdx = activeKeys.indexOf(key);
            const dir = newIdx > curIdx ? 'next' : 'prev';
            currentFocusKey = key;
            renderFocusView(dir);
        }

        function handleTouchStart(e) { touchStartX = e.touches[0].clientX; }
        function handleTouchMove(e) { }
        function handleTouchEnd(e) { touchEndX = e.changedTouches[0].clientX; handleSwipeGesture(); }
        function handleSwipeGesture() {
            const diff = touchStartX - touchEndX;
            const threshold = 50; 
            if (Math.abs(diff) < threshold) return;
            const data = appData[currentTab];
            const activeKeys = platformKeys.filter(k => data[k] && data[k].url);
            if (activeKeys.length <= 1) return;
            const currentIndex = activeKeys.indexOf(currentFocusKey);
            if (diff > 0) {
                const nextIndex = (currentIndex + 1) % activeKeys.length;
                currentFocusKey = activeKeys[nextIndex];
                renderFocusView('next');
            } else {
                const prevIndex = (currentIndex - 1 + activeKeys.length) % activeKeys.length;
                currentFocusKey = activeKeys[prevIndex];
                renderFocusView('prev');
            }
        }

        function closeFocus() {
            focusOverlay.classList.add('hidden');
            focusOverlay.innerHTML = '';
            currentFocusKey = null;
        }
    </script>
</body>
</html>